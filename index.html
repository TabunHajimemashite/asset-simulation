<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    body { font-family:'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif; margin: 26px; font-size: 26px; }
    input, select { margin-bottom: 26px; font-size: 26px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 5px; font-size: 26px; }
    th { background-color: #f0f0f0; }
    .event-entry { margin-bottom: 26px; }
    canvas { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>ğŸ“Š è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ver.1</h1>

  <h2>ğŸ”¢ åŸºæœ¬å…¥åŠ›</h2>
  <label>ç¾å¹´é½¢ï¼ˆæ­³ï¼‰ï¼š<input type="number" id="age" value="30"></label><br>
  <label>ç¾ç·è³‡ç”£é¡ï¼ˆä¸‡å††ï¼‰ï¼š<input type="number" id="totalAssets" value="1000"></label><br>
  <label>ç”Ÿæ´»é˜²è¡›é‡‘é¡ï¼ˆä¸‡å††ï¼‰ï¼š<input type="number" id="defenceAmount" value="300"></label><br>
  <label>ç¾åå…¥é¡ï¼ˆä¸‡å††/æœˆï¼‰ï¼š<input type="number" id="income" value="30"></label><br>
  <label>æƒ³å®šåˆ©å›ã‚Šï¼ˆ%/å¹´ï¼‰ï¼š<input type="number" id="rate" value="4"></label><br>
  <label><input type="checkbox" id="randomizeReturn"> åˆ©å›ã‚Šã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰å‹•ã•ã›ã‚‹</label><br>

  <label>ğŸ“‰ çµŒæ¸ˆã‚·ãƒ§ãƒƒã‚¯ç™ºç”Ÿï¼š 
    <select id="shockMode">
      <option value="none">ç™ºç”Ÿã—ãªã„</option>
      <option value="random">æ€¥ãªå¤‰å‹•ã®ç™ºç”Ÿ</option>
      <option value="deflation">ãƒ‡ãƒ•ãƒ¬ã®ã¿ç™ºç”Ÿ</option>
    </select>
  </label><br>

  <h2>ğŸ’¸ æ”¯å‡ºè¨­å®š</h2>
  <label><input type="radio" name="spendingType" value="fixed" checked> å®šé¡æ”¯å‡º</label>
  <input type="number" id="fixedExpense" value="25"> ä¸‡å††/æœˆ<br>

  <label><input type="radio" name="spendingType" value="percentage"> å¤‰å‹•æ”¯å‡º</label>
  <input type="number" id="expenseRate" value="3"> %ï¼ˆæœˆï¼‰<br>
  <label style="margin-left: 1em;">æœ€ä½æ”¯å‡ºé¡ï¼ˆä¸‡å††/æœˆï¼‰ï¼š<input type="number" id="minExpense" value="5"></label><br>

  <h2>ğŸ“… è‡¨æ™‚ã‚¤ãƒ™ãƒ³ãƒˆå…¥åŠ›</h2>
  <div id="eventList">
    <div class="event-entry">
      <input type="month" class="eventDate" value="2030-01">
      <input type="number" class="eventAmount" value="100"> ä¸‡å††
      <button onclick="this.parentNode.remove()">å‰Šé™¤</button>
    </div>
  </div>
  <button onclick="addEvent()">ï¼‹ è‡¨æ™‚ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>

  <h2>ğŸ“ˆ åæ”¯å¤‰å‹•ã‚¤ãƒ™ãƒ³ãƒˆå…¥åŠ›</h2>
  <div id="changeList">
    <div class="event-entry">
      <select class="changeTarget">
        <option value="income">åå…¥</option>
        <option value="expense">æ”¯å‡º</option>
      </select>
      <input type="month" class="changeDate" value="2035-01">
      <input type="number" class="changeAmount" value="35"> ä¸‡å††/æœˆ
      <button onclick="this.parentNode.remove()">å‰Šé™¤</button>
    </div>
  </div>
  <button onclick="addChange()">ï¼‹ åæ”¯å¤‰å‹•ã‚’è¿½åŠ </button>

  <hr>
  <button onclick="runSimulation()">â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>

  <h2>ğŸ“Š çµæœ</h2>
  <div id="result"></div>
  <canvas id="assetChart" width="1000" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>


<script>
  let chartInstance = null;

  function addEvent() {
    const container = document.getElementById('eventList');
    const div = document.createElement('div');
    div.className = 'event-entry';
    div.innerHTML = `
      <input type="month" class="eventDate">
      <input type="number" class="eventAmount"> ä¸‡å††
      <button onclick="this.parentNode.remove()">å‰Šé™¤</button>
    `;
    container.appendChild(div);
  }

  function addChange() {
    const container = document.getElementById('changeList');
    const div = document.createElement('div');
    div.className = 'event-entry';
    div.innerHTML = `
      <select class="changeTarget">
        <option value="income">åå…¥</option>
        <option value="expense">æ”¯å‡º</option>
      </select>
      <input type="month" class="changeDate">
      <input type="number" class="changeAmount"> ä¸‡å††/æœˆ
      <button onclick="this.parentNode.remove()">å‰Šé™¤</button>
    `;
    container.appendChild(div);
  }

  // âœ… æ–°ã—ã„å…¥åŠ›æ§‹é€ ã«å¯¾å¿œã—ãŸã‚¤ãƒ™ãƒ³ãƒˆå–å¾—é–¢æ•°
  function parseEvents() {
    const events = [];

    // è‡¨æ™‚ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè³‡ç”£åŠ ç®—ï¼‰
    document.querySelectorAll('#eventList .event-entry').forEach(entry => {
      const dateInput = entry.querySelector('.eventDate');
      const amountInput = entry.querySelector('.eventAmount');
      const date = dateInput?.value;
      const amount = parseFloat(amountInput?.value);
      if (date && !isNaN(amount)) {
        events.push({ type: 'extra', date, amount });
      }
    });

    // åæ”¯å¤‰å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('#changeList .event-entry').forEach(entry => {
      const target = entry.querySelector('.changeTarget')?.value;
      const date = entry.querySelector('.changeDate')?.value;
      const amount = parseFloat(entry.querySelector('.changeAmount')?.value);
      if (target && date && !isNaN(amount)) {
        events.push({ type: target === 'income' ? 'incomeChange' : 'expenseChange', date, amount });
      }
    });

    return events;
  }

  function runSimulation() {
    const startAge = parseInt(document.getElementById('age').value);
    let assets = parseFloat(document.getElementById('totalAssets').value);
    const defence = parseFloat(document.getElementById('defenceAmount').value);
    let currentIncome = parseFloat(document.getElementById('income').value);
    const baseRate = parseFloat(document.getElementById('rate').value) / 100;
    const randomize = document.getElementById('randomizeReturn').checked;
    const shockMode = document.getElementById('shockMode').value;

    const spendingType = document.querySelector('input[name="spendingType"]:checked').value;
    const fixedExpense = parseFloat(document.getElementById('fixedExpense').value);
    const expenseRate = parseFloat(document.getElementById('expenseRate').value) / 100;
    const minExpense = parseFloat(document.getElementById('minExpense').value);

    const events = parseEvents();

    let currentExpense = spendingType === 'fixed' ? fixedExpense : Math.max((assets * expenseRate) / 12, minExpense);

    let currentAge = startAge;
    let year = new Date().getFullYear();
    const results = [];
    const labels = [];
    const assetList = [];
    const incomeList = [];
    const returnList = [];
    const expenseList = [];
    const shockLog = [];

    let fireAge = null;

    while (currentAge <= 80) {
      for (let m = 1; m <= 12; m++) {
        const ym = `${year}-${String(m).padStart(2, '0')}`;

        // ğŸ”„ å„æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆåæ˜ 
        events.forEach(e => {
          if (e.date === ym) {
            if (e.type === 'extra') assets += e.amount;
            if (e.type === 'incomeChange') currentIncome = e.amount;
            if (e.type === 'expenseChange') currentExpense = e.amount;
          }
        });

        const investment = Math.max(assets - defence, 0);
        let monthlyRate = baseRate / 12;
        if (randomize) {
          const variation = 1 + (Math.random() * 0.6 - 0.3);
          monthlyRate *= variation;
        }

        let isShock = false;

        if (shockMode !== 'none' && Math.random() < 0.01) {
          const shockType = shockMode === 'deflation' ? 'deflation' : (Math.random() < 0.5 ? 'crash' : 'deflation');
          if (shockType === 'crash') {
            monthlyRate *= -0.2;
            shockLog.push({ year, month: m, label: 'âš¡æ ªä¾¡æš´è½' });
          } else if (shockType === 'deflation') {
            monthlyRate *= -0.05;
            shockLog.push({ year, month: m, label: 'ğŸ“‰ãƒ‡ãƒ•ãƒ¬' });
          }
          isShock = true;
        }

        const monthlyReturn = investment * monthlyRate;
        const net = currentIncome + monthlyReturn - currentExpense;
        assets += net;

        if (spendingType === 'percentage') {
          currentExpense = Math.max((assets * expenseRate) / 12, minExpense);
        }

        if (fireAge === null && monthlyReturn >= currentExpense) {
          fireAge = currentAge + m / 12;
        }
      }

      const investment = Math.max(assets - defence, 0);
      const monthlyReturn = investment * (baseRate / 12);

      if (currentAge % 10 === 0) {
        results.push({
          å¹´é½¢: currentAge,
          ç·è³‡ç”£é¡: Math.round(assets),
          åå…¥ã¨æŠ•è³‡åˆ©ç›Š: Math.round(currentIncome + monthlyReturn),
          æ”¯å‡ºé¡: Math.round(currentExpense)
        });
      }

      labels.push(`${currentAge}æ­³`);
      assetList.push(Math.round(assets));
      incomeList.push(currentIncome);
      returnList.push(Math.round(monthlyReturn));
      expenseList.push(-Math.round(currentExpense));

      currentAge++;
      year++;
    }

    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `<table>
      <tr><th>å¹´é½¢</th><th>ç·è³‡ç”£é¡ï¼ˆä¸‡å††ï¼‰</th><th>åå…¥+æŠ•è³‡åˆ©ç›Šï¼ˆä¸‡å††/æœˆï¼‰</th><th>æ”¯å‡ºé¡ï¼ˆä¸‡å††/æœˆï¼‰</th></tr>` +
      results.map(r => `<tr>
        <td>${r.å¹´é½¢}</td>
        <td>${r.ç·è³‡ç”£é¡.toLocaleString()}</td>
        <td>${r.åå…¥ã¨æŠ•è³‡åˆ©ç›Š.toLocaleString()}</td>
        <td>${r.æ”¯å‡ºé¡.toLocaleString()}</td>
      </tr>`).join('') +
      `</table>`;

    if (fireAge !== null) {
      resultDiv.innerHTML += `<p>ğŸ”¥ <strong>FIREé”æˆå¹´é½¢ï¼š</strong>ç´„ ${fireAge.toFixed(1)} æ­³</p>`;
    } else {
      resultDiv.innerHTML += `<p>ğŸ”¥ <strong>FIREé”æˆã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“å†…ã«ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</strong></p>`;
    }

    const ctx = document.getElementById('assetChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const annotations = {};
    shockLog.forEach((event, i) => {
      const ageLabel = `${event.year - (new Date().getFullYear() - startAge)}æ­³`;
      annotations[`shock${i}`] = {
        type: 'line',
        scaleID: 'x',
        value: ageLabel,
        borderColor: 'red',
        borderWidth: 2,
        label: {
          content: event.label,
          enabled: true,
          position: 'start',
          backgroundColor: 'rgba(255, 0, 0, 0.2)',
          font: {
            size: 10,
          }
        }
      };
    });

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            type: 'line',
            label: 'ç·è³‡ç”£é¡ï¼ˆä¸‡å††ï¼‰',
            data: assetList,
            borderColor: 'blue',
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.3
          },
          {
            label: 'åå…¥ï¼ˆä¸‡å††/æœˆï¼‰',
            data: incomeList,
            backgroundColor: 'green',
            stack: 'stack1',
            yAxisID: 'y2'
          },
          {
            label: 'æŠ•è³‡åˆ©ç›Šï¼ˆä¸‡å††/æœˆï¼‰',
            data: returnList,
            backgroundColor: 'orange',
            stack: 'stack1',
            yAxisID: 'y2'
          },
          {
            label: 'æ”¯å‡ºï¼ˆ-ä¸‡å††/æœˆï¼‰',
            data: expenseList,
            backgroundColor: 'red',
            stack: 'stack1',
            yAxisID: 'y2'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          annotation: {
            annotations: annotations
          },
          title: {
            display: true,
            text: 'è³‡ç”£æ¨ç§»ã¨æœˆæ¬¡åæ”¯ï¼ˆä¸‡å††å˜ä½ï¼‰'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            position: 'left',
            title: { display: true, text: 'ç·è³‡ç”£ï¼ˆä¸‡å††ï¼‰' },
            beginAtZero: true
          },
          y2: {
            position: 'right',
            title: { display: true, text: 'åæ”¯ï¼ˆä¸‡å††ï¼æœˆï¼‰' },
            beginAtZero: true,
            grid: { drawOnChartArea: false },
            stacked: true
          },
          x: {
            title: { display: true, text: 'å¹´é½¢ï¼ˆæ­³ï¼‰' }
          }
        }
      }
    });
  }
</script>
